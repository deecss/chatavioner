{% extends "admin/base.html" %}

{% block title %}Generator Podręcznika ATPL - Panel Admin{% endblock %}

{% block extra_head %}
<style>
    /* Tailwind CSS Reset & Override */
    .handbook-container,
    .handbook-container *,
    .handbook-sidebar,
    .handbook-sidebar *,
    .handbook-main,
    .handbook-main * {
        box-sizing: border-box !important;
    }
    
    /* Reset Tailwind margin/padding on our components */
    .handbook-container .btn,
    .handbook-container .progress-card,
    .handbook-container .tree-item,
    .handbook-container .feature-card,
    .handbook-container .steps-card {
        margin: initial !important;
        padding: initial !important;
    }

    /* Modern Design System */
    :root {
        --primary-50: #eff6ff;
        --primary-100: #dbeafe;
        --primary-500: #3b82f6;
        --primary-600: #2563eb;
        --primary-700: #1d4ed8;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --green-50: #ecfdf5;
        --green-500: #10b981;
        --green-600: #059669;
        --red-50: #fef2f2;
        --red-500: #ef4444;
        --red-600: #dc2626;
        --orange-50: #fff7ed;
        --orange-500: #f59e0b;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --radius: 0.5rem;
        --radius-lg: 0.75rem;
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Layout - Override Tailwind with !important */
    .handbook-container {
        display: grid !important;
        grid-template-columns: 380px 1fr !important;
        gap: 1.5rem !important;
        height: calc(100vh - 120px) !important;
        min-height: 600px !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .handbook-sidebar {
        background: var(--gray-50) !important;
        border: 1px solid var(--gray-200) !important;
        border-radius: var(--radius-lg) !important;
        padding: 1.5rem !important;
        overflow-y: auto !important;
        box-shadow: var(--shadow-sm) !important;
        margin: 0 !important;
    }
    
    .handbook-main {
        background: white !important;
        border: 1px solid var(--gray-200) !important;
        border-radius: var(--radius-lg) !important;
        overflow: hidden !important;
        box-shadow: var(--shadow-sm) !important;
        display: flex !important;
        flex-direction: column !important;
        margin: 0 !important;
    }

    /* Sidebar Components */
    .sidebar-header {
        margin-bottom: 1.5rem;
    }

    .sidebar-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--gray-800);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 15px;
        font-size: 14px;
        border-radius: 4px;
        border: 1px solid;
        cursor: pointer;
        text-decoration: none;
        margin: 0;
    }

    .btn-primary {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    .btn-primary:hover {
        background: #0056b3;
        border-color: #0056b3;
    }

    .btn-success {
        background: #28a745;
        color: white;
        border-color: #28a745;
    }

    .btn-success:hover {
        background: #1e7e34;
        border-color: #1e7e34;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
    }

    .btn-danger:hover {
        background: #c82333;
        border-color: #c82333;
    }

    .btn-full {
        width: 100%;
    }

    /* Progress Card */
    .progress-card {
        background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%);
        border: 1px solid var(--primary-200);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .progress-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .progress-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gray-800);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .progress-percentage {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-600);
    }

    .progress-bar-container {
        background: var(--gray-200);
        height: 8px;
        border-radius: 1rem;
        overflow: hidden;
        margin-bottom: 0.75rem;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-500), var(--green-500));
        border-radius: 1rem;
        transition: width 0.5s ease;
    }

    .progress-stats {
        font-size: 0.875rem;
        color: var(--gray-600);
        text-align: center;
    }

    /* Tree Structure - NAJPROSTSZY TEKST */
    .tree-container {
        max-height: calc(100vh - 500px);
        overflow-y: auto;
        padding: 10px;
    }

    .tree-item {
        margin-bottom: 1px;
        cursor: pointer;
    }

    .tree-item:hover {
        background: #f9f9f9;
    }

    /* Module - poziom 0 */
    .tree-item.module {
        margin-left: 0;
        margin-bottom: 5px;
    }

    /* Chapter - poziom 1 */
    .tree-item.chapter {
        margin-left: 15px;
    }

    /* Topic - poziom 2 */
    .tree-item.topic {
        margin-left: 30px;
    }

    .tree-item-content {
        padding: 5px 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .tree-item-info {
        flex: 1;
    }

    .tree-item-title {
        margin: 0;
        padding: 0;
        font-size: 14px;
        line-height: 1.4;
        color: #333;
    }

    /* Różne style dla poziomów */
    .tree-item.module .tree-item-title {
        font-size: 15px;
        font-weight: bold;
        color: #000;
    }

    .tree-item.chapter .tree-item-title {
        font-size: 14px;
        color: #333;
    }

    .tree-item.topic .tree-item-title {
        font-size: 13px;
        color: #666;
    }

    .tree-item-description {
        font-size: 12px !important;
        color: #9ca3af !important;
        line-height: 1.3 !important;
        margin: 2px 0 0 0 !important;
        display: block !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
    }

    /* Action button - MAŁY I SUBTELNY */
    .action-btn {
        font-size: 10px;
        padding: 2px 6px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 2px;
        color: #666;
        cursor: pointer;
        margin: 0;
        font-weight: normal;
    }

    .action-btn:hover {
        background: #e0e0e0;
        color: #333;
    }

    /* Status Badges - Simple and Clean */
    .status-badge {
        display: inline-flex !important;
        align-items: center !important;
        padding: 0.25rem 0.75rem !important;
        border-radius: 1rem !important;
        font-size: 0.7rem !important;
        font-weight: 600 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.025em !important;
        border: 1px solid !important;
        margin-top: 0.25rem !important;
    }

    .status-not-generated {
        background: #fef2f2 !important;
        color: #dc2626 !important;
        border-color: #fecaca !important;
    }

    .status-not-generated::before {
        content: '○' !important;
        margin-right: 0.25rem !important;
        font-weight: bold !important;
    }

    .status-generated {
        background: #ecfdf5 !important;
        color: #059669 !important;
        border-color: #a7f3d0 !important;
    }

    .status-generated::before {
        content: '●' !important;
        margin-right: 0.25rem !important;
        font-weight: bold !important;
    }

    .status-edited {
        background: #fff7ed !important;
        color: #d97706 !important;
        border-color: #fed7aa !important;
    }

    .status-edited::before {
        content: '◐' !important;
        margin-right: 0.25rem !important;
        font-weight: bold !important;
    }

    /* Main Content */
    .content-header {
        background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-900) 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .content-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .content-breadcrumb {
        font-size: 0.875rem;
        opacity: 0.8;
        color: var(--gray-300);
    }

    .content-body {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    /* Empty State */
    .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 3rem 1.5rem;
        color: var(--gray-600);
    }

    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        opacity: 0.6;
    }

    .empty-state-title {
        font-size: 1.875rem;
        font-weight: 700;
        color: var(--gray-700);
        margin-bottom: 1rem;
    }

    .empty-state-description {
        font-size: 1.125rem;
        margin-bottom: 2rem;
        max-width: 32rem;
        line-height: 1.6;
    }

    .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        max-width: 48rem;
        margin: 0 auto;
    }

    .feature-card {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        text-align: left;
        transition: var(--transition);
    }

    .feature-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .feature-title {
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .feature-description {
        font-size: 0.875rem;
        color: var(--gray-600);
        line-height: 1.4;
    }

    /* Steps */
    .steps-card {
        background: var(--primary-50);
        border: 1px solid var(--primary-200);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-top: 2rem;
        max-width: 40rem;
        margin-left: auto;
        margin-right: auto;
    }

    .steps-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-800);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .steps-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .step-item {
        color: var(--primary-700);
        margin-bottom: 1rem;
        padding-left: 0.5rem;
        line-height: 1.5;
    }

    .step-number {
        font-weight: 700;
        color: var(--primary-800);
    }

    /* Editor */
    .editor-container {
        flex: 1;
        display: none;
        flex-direction: column;
    }

    .editor-toolbar {
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-200);
        padding: 1rem 2rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
    }

    .toolbar-group {
        display: flex;
        gap: 0.25rem;
        padding-right: 0.75rem;
        border-right: 1px solid var(--gray-300);
    }

    .toolbar-group:last-child {
        border-right: none;
    }

    .toolbar-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2.5rem;
        height: 2.5rem;
        background: white;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius);
        color: var(--gray-600);
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.875rem;
    }

    .toolbar-btn:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
        color: var(--gray-700);
    }

    .toolbar-btn.active {
        background: var(--primary-500);
        border-color: var(--primary-500);
        color: white;
    }

    .toolbar-btn-text {
        padding: 0.5rem 0.75rem;
        width: auto;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .content-editor {
        flex: 1;
        border: none;
        padding: 2rem;
        font-family: 'SF Mono', Monaco, Menlo, 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        resize: none;
        outline: none;
        background: white;
        color: var(--gray-800);
    }

    .content-editor:focus {
        background: var(--gray-50);
    }

    .content-editor::placeholder {
        color: var(--gray-400);
    }

    /* Actions */
    .editor-actions {
        background: var(--gray-50);
        border-top: 1px solid var(--gray-200);
        padding: 1.5rem 2rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }

    /* AI Panel - Enhanced design */
    .ai-panel {
        background: linear-gradient(135deg, #ffffff, #f8fafc) !important;
        border-top: 3px solid var(--primary-500) !important;
        padding: 2.5rem !important;
        display: none !important;
        box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.05) !important;
    }

    .ai-title {
        font-size: 1.375rem !important;
        font-weight: 800 !important;
        color: var(--gray-800) !important;
        margin-bottom: 2.5rem !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.75rem !important;
        text-align: center !important;
        justify-content: center !important;
    }

    .ai-options {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) !important;
        gap: 1.5rem !important;
        margin-bottom: 2.5rem !important;
    }

    .ai-option {
        background: linear-gradient(135deg, #ffffff, #fafbfc) !important;
        border: 2px solid var(--gray-200) !important;
        border-radius: 1rem !important;
        padding: 2rem !important;
        cursor: pointer !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        position: relative !important;
        overflow: hidden !important;
    }

    .ai-option::before {
        content: '' !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        background: linear-gradient(135deg, transparent, rgba(59, 130, 246, 0.05)) !important;
        opacity: 0 !important;
        transition: opacity 0.3s !important;
    }

    .ai-option:hover {
        background: linear-gradient(135deg, #ffffff, #f0f9ff) !important;
        border-color: var(--primary-300) !important;
        transform: translateY(-4px) !important;
        box-shadow: 0 12px 24px rgba(59, 130, 246, 0.15) !important;
    }

    .ai-option:hover::before {
        opacity: 1 !important;
    }

    .ai-option.selected {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;
        border-color: var(--primary-500) !important;
        box-shadow: 0 8px 16px rgba(59, 130, 246, 0.25) !important;
        transform: translateY(-2px) !important;
    }

    .ai-option-title {
        font-weight: 700 !important;
        color: var(--gray-800) !important;
        margin-bottom: 0.75rem !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.75rem !important;
        font-size: 1.1rem !important;
    }

    .ai-option-description {
        font-size: 0.9rem !important;
        color: var(--gray-600) !important;
        line-height: 1.6 !important;
        opacity: 0.9 !important;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .handbook-container {
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            height: auto;
            min-height: calc(100vh - 120px);
        }
        
        .handbook-sidebar {
            height: 300px;
        }
        
        .tree-container {
            max-height: 200px;
        }
        
        .action-buttons {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .content-header {
            padding: 1rem 1.5rem;
        }
        
        .content-body {
            padding: 1.5rem;
        }
        
        .ai-options {
            grid-template-columns: 1fr;
        }
    }

    /* Utilities */
    .hidden {
        display: none !important;
    }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
</style>
{% endblock %}

{% block content %}
<!-- Override Tailwind container classes -->
<div class="handbook-container" style="display: grid !important; grid-template-columns: 380px 1fr !important; gap: 1.5rem !important; height: calc(100vh - 120px) !important; min-height: 600px !important; margin: 0 !important; padding: 0 !important;">
    <!-- Modern Sidebar -->
    <aside class="handbook-sidebar" role="complementary">
        <div class="sidebar-header">
            <h1 class="sidebar-title">
                <span class="text-2xl">📚</span>
                Podręcznik ATPL
            </h1>
            
            {% if not structure %}
                <button onclick="analyzeProgram()" 
                        class="btn btn-primary btn-full"
                        aria-label="Analizuj program ATPL">
                    <i class="fas fa-search" aria-hidden="true"></i>
                    Analizuj Program ATPL
                </button>
            {% else %}
                <div class="action-buttons">
                    <button onclick="exportHandbook()" 
                            class="btn btn-success"
                            aria-label="Eksportuj podręcznik">
                        <i class="fas fa-download" aria-hidden="true"></i>
                        Eksportuj
                    </button>
                    <button onclick="if(confirm('Czy na pewno chcesz zresetować podręcznik?')) resetHandbook();" 
                            class="btn btn-danger"
                            aria-label="Resetuj podręcznik">
                        <i class="fas fa-redo" aria-hidden="true"></i>
                        Reset
                    </button>
                </div>
            {% endif %}
        </div>

        {% if structure and structure.modules %}
            <!-- Progress Overview -->
            <div class="progress-card" role="region" aria-labelledby="progress-title">
                <div class="progress-header">
                    <h2 id="progress-title" class="progress-title">
                        <span aria-hidden="true">📊</span>
                        Postęp
                    </h2>
                    <div class="progress-percentage" aria-label="Procent ukończenia">
                        {{ progress.completion_percentage if progress else 0 }}%
                    </div>
                </div>
                <div class="progress-bar-container" role="progressbar" 
                     aria-valuenow="{{ progress.completion_percentage if progress else 0 }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100"
                     aria-label="Postęp ukończenia podręcznika">
                    <div class="progress-bar" style="width: {{ progress.completion_percentage if progress else 0 }}%"></div>
                </div>
                <div class="progress-stats">
                    {{ progress.completed_items if progress else 0 }} z {{ progress.total_items if progress else 0 }} elementów
                </div>
            </div>

            <!-- Tree Structure -->
            <nav class="tree-container" role="navigation" aria-label="Struktura podręcznika">
                {% for module in structure.modules %}
                    <div class="tree-item module" 
                         onclick="selectItem('module', '{{ module.id }}', null, null)"
                         tabindex="0"
                         role="button"
                         aria-label="Moduł: {{ module.title }}">
                        <div class="tree-item-content">
                            <div class="tree-item-info">
                                <h3 class="tree-item-title">
                                    <span aria-hidden="true">📚</span>
                                    {{ module.title }}
                                </h3>
                                <p class="tree-item-description">
                                    {{ module.description[:50] + '...' if module.description and module.description|length > 50 else module.description or 'Brak opisu' }}
                                </p>
                            </div>
                            <button onclick="event.stopPropagation(); generateContent('{{ module.id }}', null, null)" 
                                    class="action-btn"
                                    aria-label="Generuj AI dla {{ module.title }}">
                                AI
                            </button>
                        </div>
                        
                        {% if module.chapters %}
                            {% for chapter in module.chapters %}
                                <div class="tree-item chapter" 
                                     onclick="event.stopPropagation(); selectItem('chapter', '{{ module.id }}', '{{ chapter.id }}', null)"
                                     tabindex="0"
                                     role="button"
                                     aria-label="Rozdział: {{ chapter.title }}">
                                    <div class="tree-item-content">
                                        <div class="tree-item-info">
                                            <h4 class="tree-item-title">
                                                <span aria-hidden="true">📄</span>
                                                {{ chapter.title }}
                                            </h4>
                                            <p class="tree-item-description">
                                                {{ chapter.description[:40] + '...' if chapter.description and chapter.description|length > 40 else chapter.description or 'Brak opisu' }}
                                            </p>
                                            {% set chapter_key = module.id + '_' + chapter.id %}
                                            {% if progress and progress.progress_details and chapter_key in progress.progress_details %}
                                                <span class="status-badge status-{{ progress.progress_details[chapter_key].status }}">
                                                    {{ progress.progress_details[chapter_key].status|title }}
                                                </span>
                                            {% else %}
                                                <span class="status-badge status-not-generated">
                                                    Brak
                                                </span>
                                            {% endif %}
                                        </div>
                                        <button onclick="event.stopPropagation(); generateContent('{{ module.id }}', '{{ chapter.id }}', null)" 
                                                class="action-btn"
                                                aria-label="Generuj AI dla {{ chapter.title }}">
                                            AI
                                        </button>
                                    </div>
                                    
                                    {% if chapter.topics %}
                                        {% for topic in chapter.topics %}
                                            <div class="tree-item topic" 
                                                 onclick="event.stopPropagation(); selectItem('topic', '{{ module.id }}', '{{ chapter.id }}', '{{ topic.id }}')"
                                                 tabindex="0"
                                                 role="button"
                                                 aria-label="Temat: {{ topic.title }}">
                                                <div class="tree-item-content">
                                                    <div class="tree-item-info">
                                                        <h5 class="tree-item-title">
                                                            <span aria-hidden="true">📝</span>
                                                            {{ topic.title }}
                                                        </h5>
                                                        <p class="tree-item-description">
                                                            {{ topic.description[:35] + '...' if topic.description and topic.description|length > 35 else topic.description or 'Brak opisu' }}
                                                        </p>
                                                        {% set topic_key = module.id + '_' + chapter.id + '_' + topic.id %}
                                                        {% if progress and progress.progress_details and topic_key in progress.progress_details %}
                                                            <span class="status-badge status-{{ progress.progress_details[topic_key].status }}">
                                                                {{ progress.progress_details[topic_key].status|title }}
                                                            </span>
                                                        {% else %}
                                                            <span class="status-badge status-not-generated">
                                                                Brak
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    <button onclick="event.stopPropagation(); generateContent('{{ module.id }}', '{{ chapter.id }}', '{{ topic.id }}')" 
                                                            class="action-btn"
                                                            aria-label="Generuj AI dla {{ topic.title }}">
                                                        AI
                                                    </button>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                {% endfor %}
            </nav>
        {% endif %}
    </aside>

    <!-- Main Content Area -->
    <main class="handbook-main" role="main">
        {% if not structure %}
            <!-- Initial Empty State -->
            <div class="content-body">
                <div class="empty-state">
                    <div class="empty-state-icon">📚</div>
                    <h1 class="empty-state-title">Generator Podręcznika ATPL</h1>
                    <p class="empty-state-description">
                        Automatyczne tworzenie podręcznika szkoleniowego na podstawie programu ATPL
                    </p>
                    
                    <div class="steps-card">
                        <h2 class="steps-title">
                            <span aria-hidden="true">🚀</span>
                            Jak rozpocząć
                        </h2>
                        <ol class="steps-list">
                            <li class="step-item">
                                <span class="step-number">1.</span> Kliknij "Analizuj Program ATPL" aby przeanalizować strukturę dokumentu
                            </li>
                            <li class="step-item">
                                <span class="step-number">2.</span> System automatycznie wyciągnie moduły, rozdziały i tematy
                            </li>
                            <li class="step-item">
                                <span class="step-number">3.</span> Wybierz element i kliknij "AI" aby wygenerować treść
                            </li>
                            <li class="step-item">
                                <span class="step-number">4.</span> Edytuj treść w zaawansowanym edytorze
                            </li>
                            <li class="step-item">
                                <span class="step-number">5.</span> Eksportuj gotowy podręcznik
                            </li>
                        </ol>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- Content Editor State -->
            <div class="content-body" id="emptyState">
                <div class="empty-state">
                    <div class="empty-state-icon">✨</div>
                    <h1 class="empty-state-title">Wybierz element do edycji</h1>
                    <p class="empty-state-description">
                        Kliknij na dowolny moduł, rozdział lub temat w strukturze po lewej stronie
                    </p>
                    
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h3 class="feature-title">
                                <span aria-hidden="true">📚</span>
                                Moduły
                            </h3>
                            <p class="feature-description">
                                Główne działy programu szkoleniowego
                            </p>
                        </div>
                        <div class="feature-card">
                            <h3 class="feature-title">
                                <span aria-hidden="true">📄</span>
                                Rozdziały
                            </h3>
                            <p class="feature-description">
                                Sekcje tematyczne w ramach modułów
                            </p>
                        </div>
                        <div class="feature-card">
                            <h3 class="feature-title">
                                <span aria-hidden="true">📝</span>
                                Tematy
                            </h3>
                            <p class="feature-description">
                                Szczegółowe zagadnienia do opracowania
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Editor Panel -->
            <div class="editor-container" id="editorPanel">
                <!-- Header -->
                <div class="content-header">
                    <h1 class="content-title" id="editorTitle">Edytor treści</h1>
                    <div class="content-breadcrumb" id="editorBreadcrumb">Wybierz element</div>
                </div>

                <!-- AI Panel -->
                <div class="ai-panel" id="aiPanel">
                    <h2 class="ai-title">
                        <span aria-hidden="true">🤖</span>
                        Asystent AI - Generator Treści
                    </h2>
                    <div class="ai-options">
                        <div class="ai-option" data-type="comprehensive">
                            <h3 class="ai-option-title">
                                <span aria-hidden="true">📖</span>
                                Kompletny Przewodnik
                            </h3>
                            <p class="ai-option-description">
                                Szczegółowa treść z teorią, przykładami i procedurami
                            </p>
                        </div>
                        <div class="ai-option" data-type="summary">
                            <h3 class="ai-option-title">
                                <span aria-hidden="true">📋</span>
                                Streszczenie
                            </h3>
                            <p class="ai-option-description">
                                Zwięzłe omówienie najważniejszych punktów
                            </p>
                        </div>
                        <div class="ai-option" data-type="practical">
                            <h3 class="ai-option-title">
                                <span aria-hidden="true">🛠️</span>
                                Praktyczne Aspekty
                            </h3>
                            <p class="ai-option-description">
                                Fokus na zastosowanie w praktyce lotniczej
                            </p>
                        </div>
                        <div class="ai-option" data-type="regulatory">
                            <h3 class="ai-option-title">
                                <span aria-hidden="true">⚖️</span>
                                Przepisy i Regulacje
                            </h3>
                            <p class="ai-option-description">
                                Szczegółowe omówienie przepisów ICAO/EASA
                            </p>
                        </div>
                    </div>
                    <div class="editor-actions">
                        <button onclick="generateWithAI()" class="btn btn-success">
                            <i class="fas fa-magic" aria-hidden="true"></i>
                            Wygeneruj Treść AI
                        </button>
                        <button onclick="hideAIPanel()" class="btn btn-danger">
                            Anuluj
                        </button>
                    </div>
                </div>

                <!-- Toolbar -->
                <div class="editor-toolbar" id="editorToolbar" style="display: none;">
                    <div class="toolbar-group">
                        <button class="toolbar-btn" onclick="formatText('bold')" title="Pogrubienie">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button class="toolbar-btn" onclick="formatText('italic')" title="Kursywa">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button class="toolbar-btn" onclick="formatText('underline')" title="Podkreślenie">
                            <i class="fas fa-underline"></i>
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn toolbar-btn-text" onclick="formatText('h1')" title="Nagłówek 1">H1</button>
                        <button class="toolbar-btn toolbar-btn-text" onclick="formatText('h2')" title="Nagłówek 2">H2</button>
                        <button class="toolbar-btn toolbar-btn-text" onclick="formatText('h3')" title="Nagłówek 3">H3</button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" onclick="formatText('ul')" title="Lista punktowana">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button class="toolbar-btn" onclick="formatText('ol')" title="Lista numerowana">
                            <i class="fas fa-list-ol"></i>
                        </button>
                        <button class="toolbar-btn" onclick="formatText('quote')" title="Cytat">
                            <i class="fas fa-quote-left"></i>
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" onclick="insertImage()" title="Wstaw obraz">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="toolbar-btn" onclick="insertTable()" title="Wstaw tabelę">
                            <i class="fas fa-table"></i>
                        </button>
                        <button class="toolbar-btn" onclick="insertCode()" title="Kod">
                            <i class="fas fa-code"></i>
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn toolbar-btn-text" onclick="togglePreview()" title="Podgląd" id="previewBtn">
                            <i class="fas fa-eye"></i> Podgląd
                        </button>
                    </div>
                </div>

                <!-- Editor -->
                <textarea class="content-editor" id="contentEditor" style="display: none;" 
                          placeholder="Rozpocznij pisanie lub wygeneruj treść za pomocą AI..."
                          aria-label="Edytor treści"></textarea>

                <!-- Actions -->
                <div class="editor-actions" id="saveActions" style="display: none;">
                    <button onclick="saveContent()" class="btn btn-success">
                        <i class="fas fa-save" aria-hidden="true"></i>
                        Zapisz Zmiany
                    </button>
                    <button onclick="cancelEdit()" class="btn btn-danger">
                        <i class="fas fa-times" aria-hidden="true"></i>
                        Anuluj
                    </button>
                    <button onclick="showAIPanel()" class="btn btn-primary">
                        <i class="fas fa-robot" aria-hidden="true"></i>
                        Regeneruj AI
                    </button>
                    <button onclick="exportCurrentContent()" class="btn btn-primary">
                        <i class="fas fa-download" aria-hidden="true"></i>
                        Eksportuj
                    </button>
                </div>
            </div>
        {% endif %}
    </main>
</div>

<script>
// Globalne zmienne
let currentEditItem = null;
let currentContent = '';
let isPreviewMode = false;
let selectedAIType = 'comprehensive';

// Inicjalizacja
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
});

function setupEventListeners() {
    // AI Panel options
    document.querySelectorAll('.ai-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.ai-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            selectedAIType = this.dataset.type;
        });
    });

    // Auto-resize editor
    const editor = document.getElementById('contentEditor');
    if (editor) {
        editor.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    }
}

// === MAIN FUNCTIONALITY ===

async function analyzeProgram() {
    try {
        showLoading('🔍 Analizuję program ATPL...', 'Może to potrwać kilka minut');
        
        const response = await fetch('/admin/api/handbook/analyze-program', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('✅ ' + result.message, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showMessage('❌ Błąd: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Błąd analizy programu:', error);
        showMessage('❌ Błąd analizy: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function selectItem(type, moduleId, chapterId, topicId) {
    currentEditItem = { type, moduleId, chapterId, topicId };
    
    const title = buildItemTitle(type, moduleId, chapterId, topicId);
    const breadcrumb = buildBreadcrumb(type, moduleId, chapterId, topicId);
    
    document.getElementById('editorTitle').textContent = `✏️ ${title}`;
    document.getElementById('editorBreadcrumb').textContent = breadcrumb;
    
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('editorPanel').style.display = 'flex';
    
    loadContent(moduleId, chapterId, topicId);
}

async function generateContent(moduleId, chapterId, topicId) {
    currentEditItem = { moduleId, chapterId, topicId };
    
    showAIPanel();
    
    const title = buildItemTitle('generate', moduleId, chapterId, topicId);
    document.getElementById('editorTitle').textContent = `🤖 Generowanie: ${title}`;
    
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('editorPanel').style.display = 'flex';
}

async function generateWithAI() {
    if (!currentEditItem) return;
    
    try {
        const { moduleId, chapterId, topicId } = currentEditItem;
        const item = buildItemTitle('item', moduleId, chapterId, topicId);
        
        showLoading(`🤖 Generuję treść AI: ${item}`, `Typ: ${selectedAIType}`);
        hideAIPanel();
        
        const response = await fetch('/admin/api/handbook/generate-content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                module_id: moduleId,
                chapter_id: chapterId,
                topic_id: topicId,
                ai_type: selectedAIType
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentContent = result.content || '';
            showEditor(true);
            document.getElementById('contentEditor').value = currentContent;
            showMessage('✅ Treść wygenerowana pomyślnie!', 'success');
        } else {
            showMessage('❌ Błąd: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Błąd generowania treści:', error);
        showMessage('❌ Błąd generowania: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function loadContent(moduleId, chapterId, topicId) {
    try {
        const params = new URLSearchParams({ module_id: moduleId, chapter_id: chapterId });
        if (topicId) params.append('topic_id', topicId);
        
        const response = await fetch(`/admin/api/handbook/content?${params}`);
        const result = await response.json();
        
        if (result.success && result.content) {
            currentContent = result.content;
            showEditor(true);
            document.getElementById('contentEditor').value = currentContent;
        } else {
            showEditor(false);
            showMessage('ℹ️ Brak treści. Wygeneruj za pomocą AI lub zacznij pisać.', 'info');
        }
    } catch (error) {
        console.error('Błąd ładowania treści:', error);
        showMessage('❌ Błąd ładowania treści: ' + error.message, 'error');
    }
}

async function saveContent() {
    if (!currentEditItem) return;
    
    try {
        const { moduleId, chapterId, topicId } = currentEditItem;
        const content = document.getElementById('contentEditor').value;
        
        showLoading('💾 Zapisuję zmiany...');
        
        const response = await fetch('/admin/api/handbook/save-content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                module_id: moduleId,
                chapter_id: chapterId,
                topic_id: topicId,
                content: content
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentContent = content;
            showMessage('✅ Zmiany zapisane pomyślnie!', 'success');
        } else {
            showMessage('❌ Błąd: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Błąd zapisywania:', error);
        showMessage('❌ Błąd zapisywania: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// === UI CONTROL FUNCTIONS ===

function showEditor(hasContent) {
    document.getElementById('editorToolbar').style.display = 'flex';
    document.getElementById('contentEditor').style.display = 'block';
    document.getElementById('saveActions').style.display = 'flex';
}

function showAIPanel() {
    document.getElementById('aiPanel').style.display = 'block';
    document.getElementById('editorToolbar').style.display = 'none';
    document.getElementById('contentEditor').style.display = 'none';
    document.getElementById('saveActions').style.display = 'none';
}

function hideAIPanel() {
    document.getElementById('aiPanel').style.display = 'none';
}

function cancelEdit() {
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('editorPanel').style.display = 'none';
    currentEditItem = null;
    currentContent = '';
    document.getElementById('contentEditor').value = '';
}

// === FORMATTING FUNCTIONS ===

function formatText(type) {
    const editor = document.getElementById('contentEditor');
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const selectedText = editor.value.substring(start, end);
    const beforeText = editor.value.substring(0, start);
    const afterText = editor.value.substring(end);
    
    let formattedText = '';
    
    switch (type) {
        case 'bold':
            formattedText = `**${selectedText || 'tekst'}**`;
            break;
        case 'italic':
            formattedText = `*${selectedText || 'tekst'}*`;
            break;
        case 'underline':
            formattedText = `<u>${selectedText || 'tekst'}</u>`;
            break;
        case 'h1':
            formattedText = `# ${selectedText || 'Nagłówek 1'}`;
            break;
        case 'h2':
            formattedText = `## ${selectedText || 'Nagłówek 2'}`;
            break;
        case 'h3':
            formattedText = `### ${selectedText || 'Nagłówek 3'}`;
            break;
        case 'ul':
            formattedText = `- ${selectedText || 'Element listy'}`;
            break;
        case 'ol':
            formattedText = `1. ${selectedText || 'Element listy'}`;
            break;
        case 'quote':
            formattedText = `> ${selectedText || 'Cytat'}`;
            break;
    }
    
    editor.value = beforeText + formattedText + afterText;
    editor.focus();
    
    const newPosition = start + formattedText.length;
    editor.setSelectionRange(newPosition, newPosition);
}

function insertImage() {
    const imageMarkdown = '![Opis obrazu](url-obrazu)';
    insertTextAtCursor(imageMarkdown);
}

function insertTable() {
    const tableMarkdown = `
| Kolumna 1 | Kolumna 2 | Kolumna 3 |
|-----------|-----------|-----------|
| Wiersz 1  | Dane      | Dane      |
| Wiersz 2  | Dane      | Dane      |
`;
    insertTextAtCursor(tableMarkdown);
}

function insertCode() {
    const codeMarkdown = '```\n// Twój kod tutaj\n```';
    insertTextAtCursor(codeMarkdown);
}

function insertTextAtCursor(text) {
    const editor = document.getElementById('contentEditor');
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const beforeText = editor.value.substring(0, start);
    const afterText = editor.value.substring(end);
    
    editor.value = beforeText + text + afterText;
    editor.focus();
    
    const newPosition = start + text.length;
    editor.setSelectionRange(newPosition, newPosition);
}

function togglePreview() {
    // Simple toggle implementation
    const previewBtn = document.getElementById('previewBtn');
    isPreviewMode = !isPreviewMode;
    
    if (isPreviewMode) {
        previewBtn.innerHTML = '<i class="fas fa-edit"></i> Edytuj';
        previewBtn.classList.add('active');
    } else {
        previewBtn.innerHTML = '<i class="fas fa-eye"></i> Podgląd';
        previewBtn.classList.remove('active');
    }
}

// === UTILITY FUNCTIONS ===

function buildItemTitle(type, moduleId, chapterId, topicId) {
    if (topicId) return `Temat ${topicId}`;
    if (chapterId) return `Rozdział ${chapterId}`;
    return `Moduł ${moduleId}`;
}

function buildBreadcrumb(type, moduleId, chapterId, topicId) {
    let breadcrumb = `Moduł ${moduleId}`;
    if (chapterId) breadcrumb += ` › Rozdział ${chapterId}`;
    if (topicId) breadcrumb += ` › Temat ${topicId}`;
    return breadcrumb;
}

// === EXPORT FUNCTIONS ===

async function exportHandbook() {
    try {
        showLoading('📄 Eksportuję podręcznik...', 'Tworzenie pliku PDF');
        
        const response = await fetch('/admin/api/handbook/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ format: 'markdown' })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const link = document.createElement('a');
            link.href = result.download_url;
            link.download = result.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('✅ Podręcznik wyeksportowany pomyślnie!', 'success');
        } else {
            showMessage('❌ Błąd eksportu: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Błąd eksportu:', error);
        showMessage('❌ Błąd eksportu: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function exportCurrentContent() {
    if (!currentEditItem || !currentContent) {
        showMessage('❌ Brak treści do eksportu', 'error');
        return;
    }
    
    const { moduleId, chapterId, topicId } = currentEditItem;
    const title = buildItemTitle('item', moduleId, chapterId, topicId);
    
    const blob = new Blob([currentContent], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${title}.md`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showMessage('✅ Treść wyeksportowana!', 'success');
}

async function resetHandbook() {
    try {
        showLoading('🔄 Resetuję podręcznik...', 'Usuwanie danych');
        
        const response = await fetch('/admin/api/handbook/reset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('✅ Podręcznik zresetowany pomyślnie!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage('❌ Błąd resetowania: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Błąd resetowania:', error);
        showMessage('❌ Błąd resetowania: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// === HELPER FUNCTIONS ===

function showLoading(message, subtitle = '') {
    const loadingHtml = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: white; border-radius: 0.75rem; padding: 2rem; max-width: 20rem; text-align: center; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);">
                <div style="width: 3rem; height: 3rem; border: 3px solid #e5e7eb; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                <h3 style="font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">${message}</h3>
                ${subtitle ? `<p style="font-size: 0.875rem; color: #6b7280;">${subtitle}</p>` : ''}
            </div>
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    `;
    document.body.insertAdjacentHTML('beforeend', loadingHtml);
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.remove();
    }
}

function showMessage(message, type = 'info') {
    const colors = {
        'success': '#10b981',
        'error': '#ef4444',
        'info': '#3b82f6',
        'warning': '#f59e0b'
    };
    
    const messageHtml = `
        <div id="messageToast" style="position: fixed; top: 1rem; right: 1rem; background: white; border: 1px solid #e5e7eb; border-left: 4px solid ${colors[type] || colors.info}; border-radius: 0.75rem; padding: 1rem 1.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); z-index: 1500; max-width: 24rem; display: flex; align-items: center; gap: 0.75rem;">
            <div style="flex: 1; font-size: 0.875rem; color: #374151; line-height: 1.4;">${message}</div>
            <button onclick="this.parentElement.remove()" style="color: #9ca3af; background: none; border: none; cursor: pointer; font-size: 1.125rem; padding: 0.25rem; border-radius: 0.5rem;">×</button>
        </div>
    `;
    
    document.querySelectorAll('#messageToast').forEach(el => el.remove());
    document.body.insertAdjacentHTML('beforeend', messageHtml);
    
    setTimeout(() => {
        const toast = document.getElementById('messageToast');
        if (toast) toast.remove();
    }, 5000);
}
</script>
{% endblock %}
